CVE-2016-4622
===

*   Original [files](https://github.com/saelo/jscpwn)
*   Original [Write-up](http://www.phrack.org/papers/attacking_javascript_engines.html)

## Vuln

The vuln was in the `arrayProtoFuncSlice` function in the `ArrayPrototype.cpp` file.
You can read the original write-up for a very detailed explanation.
The vuln was fixed in:

```
commit 650552a6ed7cac8aed3f53dd464341728984b82f (HEAD)
Author: msaboff@apple.com <msaboff@apple.com@268f45cc-cd09-0410-ab3c-d52691b4dbfc>
Date:   Tue May 3 21:42:44 2016 +0000

    Crash: Array.prototype.slice() and .splice() can call fastSlice() after an array is truncated
    https://bugs.webkit.org/show_bug.cgi?id=157322

    Reviewed by Filip Pizlo.

    Check to see if the source array has changed length before calling fastSlice().
    If it has, take the slow path.

    * runtime/ArrayPrototype.cpp:
    (JSC::arrayProtoFuncSlice):
    (JSC::arrayProtoFuncSplice):
    * tests/stress/regress-157322.js: New test.


    git-svn-id: http://svn.webkit.org/repository/webkit/trunk@200387 268f45cc-cd09-0410-ab3c-d52691b4dbfc

...

diff --git a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
index cfdd7fceb7f..08a6ec991af 100644
--- a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
+++ b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
@@ -863,7 +863,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)
     if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception))
         return JSValue::encode(jsUndefined());
 
-    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj))) {
+    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj) && length == getLength(exec, thisObj))) {
         if (JSArray* result = asArray(thisObj)->fastSlice(*exec, begin, end - begin))
             return JSValue::encode(result);
     }
@@ -932,7 +932,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSplice(ExecState* exec)
         return JSValue::encode(jsUndefined());
 
     JSObject* result = nullptr;
-    if (speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj))
+    if (speciesResult.first == SpeciesConstructResult::FastPath && isJSArray(thisObj) && length == getLength(exec, thisObj))
         result = asArray(thisObj)->fastSlice(*exec, begin, deleteCount);
 
     if (!result) {
...
```

This makes `320b1fc3f6f47a31b6ccb4578bcea56c32c9e10` the latest commit with the vulnerable code.


## Build Vuln-JSC (Ubuntu 18.04)

I've tried to build `320b1fc3f6f47a31b6ccb4578bcea56c32c9e10` on Ubuntu 18.04, but this code being almost 3 years old by now, didn't compile anymore.
You can check [browser-pwn](https://github.com/m1ghtym0/browser-pwn) for more details on how to build WebKit/JavaScriptCore.
If you're more into fixing old build-chains than me or you're just running an older system, try (try_build.sh)[try_build.sh].

Otherwise, I've created a patch, which basically reverts the fix shown above.
Additionally, I had to disable the `verifyPropertiesAreInitialized` call in ObjectInitializationScope.cpp, to reach the vulnerable pattern.
You should be able to apply the patch on top of master (tested on e50a736101bfad47587e7417e551008ada4ba553):

```
$ cp vuln.patch <WebKit-dir>
$ cd <WebKit-dir>
$ git checkout e50a736101bfad47587e7417e551008ada4ba553
$ git apply vuln.patch
```

If you don't want to build jsc yourself, I've uploaded the [jsc-binary](https://www.mightym0.de/write-ups/browser/cve-2016-4622/bin/jsc) and [libJavaScriptCore.so.1](https://www.mightym0.de/write-ups/browser/cve-2016-4622/bin/libJavaScriptCore.so.1) binaries.

